language: java
jdk:
  - openjdk8
  - openjdk9

script:
  - ./gradlew clean jar

after_success:
  - find . -name jacocoTestReport.csv|xargs cat|awk -F',' '{print $3" "$4" "$5}'

stages:
  - test
  - deploy

jobs:
  include:
    - stage: test
      name: "UI check - JDK8"
      jdk: openjdk8
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/ui check
      env:
      - COVERAGE_THRESHOLD=0.05
    - stage: test
      name: "Cart Service check - JDK8"
      jdk: openjdk8
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/service/cart check
      env:
      - COVERAGE_THRESHOLD=0.14
    - stage: test
      name: "User Service check - JDK8"
      jdk: openjdk8
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/service/user check
      env:
      - COVERAGE_THRESHOLD=0.0
    - stage: test
      name: "Order repository check - JDK8"
      jdk: openjdk8
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/order check
      env:
      - COVERAGE_THRESHOLD=0.3
    - stage: test
      name: "Cart repository check - JDK8"
      jdk: openjdk8
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/cart check
      env:
      - COVERAGE_THRESHOLD=0.0
    - stage: test
      name: "Product repository check - JDK8"
      jdk: openjdk8
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/product check
      env:
      - COVERAGE_THRESHOLD=0.12
    - stage: test
      name: "User repository check - JDK8"
      jdk: openjdk8
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/user check
      env:
      - COVERAGE_THRESHOLD=0.3
    - stage: test
      name: "UI check - JDK9"
      jdk: openjdk9
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/ui check
      env:
      - COVERAGE_THRESHOLD=0.05
    - stage: test
      name: "Cart Service check - JDK9"
      jdk: openjdk9
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/service/cart check
      env:
      - COVERAGE_THRESHOLD=0.14
    - stage: test
      name: "User Service check - JDK9"
      jdk: openjdk9
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/service/user check
      env:
      - COVERAGE_THRESHOLD=0.0
    - stage: test
      name: "Order repository check - JDK9"
      jdk: openjdk9
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/order check
      env:
      - COVERAGE_THRESHOLD=0.3
    - stage: test
      name: "Cart repository check - JDK9"
      jdk: openjdk9
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/cart check
      env:
      - COVERAGE_THRESHOLD=0.0
    - stage: test
      name: "Product repository check - JDK9"
      jdk: openjdk9
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/product check
      env:
      - COVERAGE_THRESHOLD=0.12
    - stage: test
      name: "User repository check - JDK9"
      jdk: openjdk9
      install: skip
      script:
      - COVERAGE=$COVERAGE_THRESHOLD ./gradlew -p ./monolithic/repository/user check
      env:
      - COVERAGE_THRESHOLD=0.3
    - stage: deploy
      name: "Deploy"
      script: skip
      deploy:
        provider: script
        script: echo "WIP"
        on:
          all_branches: true
